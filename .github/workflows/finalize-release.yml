name: Finalize Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  finalize-release:
    name: Finalize Release
    runs-on: ubuntu-latest
    # Only run when a release PR is squash-merged to main with chore(release): message
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate release prerequisites
        id: validate
        run: |
          echo "::group::Validating release prerequisites"

          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: ${COMMIT_MSG}"

          # Check if the commit message follows the expected pattern: chore(release): X.Y.Z
          if [[ ! "${COMMIT_MSG}" =~ ^chore\(release\):\ [0-9]+\.[0-9]+\.[0-9]+($|[[:space:]]) ]]; then
            echo "❌ Error: Commit message does not match expected release format"
            exit 1
          fi
          echo "✅ Commit message matches expected release format"

          # Extract and validate version from pyproject.toml
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Error: Invalid version format in pyproject.toml"
            exit 1
          fi
          echo "✅ Version in pyproject.toml: ${VERSION}"

          # Verify CHANGELOG entry exists
          if ! grep -q "^## \[${VERSION}\]" CHANGELOG.md; then
            echo "❌ Error: No CHANGELOG entry found for version ${VERSION}"
            exit 1
          fi
          echo "✅ CHANGELOG contains entry for version ${VERSION}"

          echo "::endgroup::"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        id: create_tag
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          TAG="v${VERSION}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

          echo "✅ Created and pushed tag: ${TAG}"

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=${{ steps.validate.outputs.version }}
          CHANGELOG_SECTION=$(awk "/^## \[${VERSION}\]/,/^## \[/ {if (/^## \[${VERSION}\]/) p=1; if (p && /^## \[/ && !/^## \[${VERSION}\]/) exit; if (p) print}" CHANGELOG.md)
          echo "${CHANGELOG_SECTION}" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: Release ${{ steps.create_tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge main back to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch develop branch
          git fetch origin develop:develop

          # Checkout develop
          git checkout develop

          # Merge main into develop to keep them in sync
          git merge origin/main --no-edit -m "chore: merge release ${{ steps.validate.outputs.version }} back to develop"

          # Push to develop
          git push origin develop

          echo "✅ Merged main back to develop to keep branches in sync"
          echo "✅ Build macOS Binary workflow will run automatically to attach the binary"
