name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      release_needed: ${{ steps.semantic.outputs.release_needed }}
      next_version: ${{ steps.semantic.outputs.next_version }}
    # Skip if this is a release PR merge (we'll handle that separately)
    # Skip if commit message already contains chore(release):
    if: ${{ !startsWith(github.event.head_commit.message, 'chore(release):') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install python-semantic-release
        run: |
          python -m pip install --upgrade pip
          pip install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Semantic Release (determine version)
        id: semantic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the next version without making changes
          NEXT_VERSION=$(semantic-release version --print 2>/dev/null || echo "")

          if [ -n "$NEXT_VERSION" ]; then
            echo "next_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
            echo "release_needed=true" >> $GITHUB_OUTPUT
            echo "Next version will be: ${NEXT_VERSION}"
          else
            echo "release_needed=false" >> $GITHUB_OUTPUT
            echo "No release needed (no relevant commits since last release)"
          fi

      - name: Update version files and CHANGELOG
        if: steps.semantic.outputs.release_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Update files locally (version, CHANGELOG)
          semantic-release version --commit --tag --changelog --no-push

      - name: Create Release Pull Request
        if: steps.semantic.outputs.release_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.semantic.outputs.next_version }}
          BRANCH="release/${VERSION}"

          # Create a new branch for the release
          git checkout -b "${BRANCH}"

          # Push the branch
          git push origin "${BRANCH}"

          # Create PR
          gh pr create \
            --title "chore(release): ${VERSION}" \
            --body "Automated release PR for version ${VERSION}

          This PR was automatically created by the semantic-release workflow.

          ## Changes
          - Version bump to ${VERSION}
          - Updated CHANGELOG.md
          - Updated pyproject.toml

          Once merged, the release workflow will automatically:
          - Create a GitHub release with tag v${VERSION}
          - Build and attach macOS binary

          **Please review and merge to complete the release.**" \
            --base main \
            --head "${BRANCH}"

      - name: Comment on PR with next steps
        if: steps.semantic.outputs.release_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Release PR created successfully!"
          echo "ðŸ‘‰ Review and merge the PR to complete the release"

  finalize-release:
    name: Finalize Release (after PR merge)
    runs-on: ubuntu-latest
    # Only run when a release PR is merged to main
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version and create tag
        id: create_tag
        run: |
          # Extract version from pyproject.toml
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG="v${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          # Create and push the tag
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

          echo "âœ… Created and pushed tag: ${TAG}"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.create_tag.outputs.version }}

          # Extract the changelog section for this version
          CHANGELOG_SECTION=$(awk "/^## \[${VERSION}\]/,/^## \[/ {if (/^## \[${VERSION}\]/) p=1; if (p && /^## \[/ && !/^## \[${VERSION}\]/) exit; if (p) print}" CHANGELOG.md)

          # Save to file for upload
          echo "${CHANGELOG_SECTION}" > release_notes.md
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: Release ${{ steps.create_tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binary:
    name: Build macOS Binary
    needs: finalize-release
    runs-on: macos-latest
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Checkout code at tag
        run: |
          git checkout ${{ steps.get_tag.outputs.tag }}

      - name: Ensure new release was created
        id: check_new_release
        run: |
          # Get the commit hash for the tag
          TAG_COMMIT=$(git rev-list -n 1 ${{ steps.get_tag.outputs.tag }})
          # Get the commit hash for HEAD
          HEAD_COMMIT=$(git rev-parse HEAD)
          if [ "$TAG_COMMIT" != "$HEAD_COMMIT" ]; then
            echo "No new release was created in this run. Skipping binary build."
            exit 1
          fi
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller

      - name: Build binary with PyInstaller
        run: |
          pyinstaller --onefile --name run-calc bin/run_calc.py

      - name: Test binary
        run: |
          ./dist/run-calc add 2 3
          ./dist/run-calc multiply 4 5
          ./dist/run-calc average 10 20 30
          ./dist/run-calc --help

      - name: Rename binary
        run: |
          mv dist/run-calc dist/run-calc-macos-arm64

      - name: Upload binary to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          files: dist/run-calc-macos-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
