name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      release_needed: ${{ steps.semantic.outputs.release_needed }}
      next_version: ${{ steps.semantic.outputs.next_version }}
    # Skip if this is a release PR merge (we'll handle that separately)
    # Skip if commit message already contains chore(release):
    if: ${{ !startsWith(github.event.head_commit.message, 'chore(release):') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install python-semantic-release
        run: |
          python -m pip install --upgrade pip
          pip install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Semantic Release (determine version)
        id: semantic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the next version without making changes
          NEXT_VERSION=$(semantic-release version --print 2>/dev/null || echo "")

          if [ -n "$NEXT_VERSION" ]; then
            echo "next_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
            echo "release_needed=true" >> $GITHUB_OUTPUT
            echo "Next version will be: ${NEXT_VERSION}"
          else
            echo "release_needed=false" >> $GITHUB_OUTPUT
            echo "No release needed (no relevant commits since last release)"
          fi

      - name: Create release branch and PR
        if: steps.semantic.outputs.release_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.semantic.outputs.next_version }}
          BRANCH="release/${VERSION}"

          # Clean up any existing branch (local and remote) for reruns
          git branch -D "${BRANCH}" 2>/dev/null || true
          if git ls-remote --heads origin "${BRANCH}" | grep -q "${BRANCH}"; then
            git push origin --delete "${BRANCH}" 2>/dev/null || true
          fi

          # Create the version commit on main branch first (no tag - that happens in finalize-release)
          semantic-release version --commit --changelog --no-push --no-tag

          # Now create and push the release branch with the version commit
          git checkout -b "${BRANCH}"
          git push origin "${BRANCH}"

          # Create PR
          gh pr create \
            --title "chore(release): ${VERSION}" \
            --body "Automated release PR for version ${VERSION}

          This PR was automatically created by the semantic-release workflow.

          ## Changes
          - Version bump to ${VERSION}
          - Updated CHANGELOG.md
          - Updated pyproject.toml

          Once merged, the release workflow will automatically:
          - Create a GitHub release with tag v${VERSION}
          - Build and attach macOS binary

          **Please review and merge to complete the release.**" \
            --base main \
            --head "${BRANCH}"

      - name: Log success message
        if: steps.semantic.outputs.release_needed == 'true'
        run: |
          echo "âœ… Release PR created successfully!"
          echo "ðŸ‘‰ Review and merge the PR to complete the release"

  finalize-release:
    name: Finalize Release (after PR merge)
    runs-on: ubuntu-latest
    # Only run when a release PR is merged to main
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate release prerequisites
        id: validate
        run: |
          echo "::group::Validating release prerequisites"

          # 1. Verify commit came from a release branch merge
          # Extract the branch name from the commit message or ref
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: ${COMMIT_MSG}"

          # Check if the commit message follows the expected pattern: chore(release): X.Y.Z
          if [[ ! "${COMMIT_MSG}" =~ ^chore\(release\):\ [0-9]+\.[0-9]+\.[0-9]+($|[[:space:]]) ]]; then
            echo "âŒ Error: Commit message does not match expected release format 'chore(release): X.Y.Z'"
            echo "   Got: ${COMMIT_MSG}"
            exit 1
          fi
          echo "âœ… Commit message matches expected release format"

          # 2. Validate version in pyproject.toml matches expected semver format
          if [ ! -f "pyproject.toml" ]; then
            echo "âŒ Error: pyproject.toml not found"
            exit 1
          fi

          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

          if [ -z "${VERSION}" ]; then
            echo "âŒ Error: Could not extract version from pyproject.toml"
            exit 1
          fi

          echo "Version from pyproject.toml: ${VERSION}"

          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version in pyproject.toml does not match semver format (X.Y.Z)"
            echo "   Got: ${VERSION}"
            exit 1
          fi
          echo "âœ… Version in pyproject.toml matches semver format"

          # 3. Verify CHANGELOG entry exists for this version
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ Error: CHANGELOG.md not found"
            exit 1
          fi

          # Check if CHANGELOG contains an entry for this version
          if ! grep -q "^## \[${VERSION}\]" CHANGELOG.md; then
            echo "âŒ Error: No CHANGELOG entry found for version ${VERSION}"
            echo "   Expected to find: ## [${VERSION}]"
            exit 1
          fi
          echo "âœ… CHANGELOG contains entry for version ${VERSION}"

          # 4. Verify the version in commit message matches pyproject.toml
          COMMIT_VERSION=$(echo "${COMMIT_MSG}" | sed -n 's/^chore(release): \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          if [ "${COMMIT_VERSION}" != "${VERSION}" ]; then
            echo "âŒ Error: Version mismatch between commit message and pyproject.toml"
            echo "   Commit message version: ${COMMIT_VERSION}"
            echo "   pyproject.toml version: ${VERSION}"
            exit 1
          fi
          echo "âœ… Version in commit message matches pyproject.toml"

          echo "::endgroup::"
          echo "âœ… All release prerequisites validated successfully"

          # Export version for later steps
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Extract version and create tag
        id: create_tag
        run: |
          # Use the validated version from the previous step
          VERSION="${{ steps.validate.outputs.version }}"
          TAG="v${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          # Create and push the tag
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

          echo "âœ… Created and pushed tag: ${TAG}"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.create_tag.outputs.version }}

          # Extract the changelog section for this version
          CHANGELOG_SECTION=$(awk "/^## \[${VERSION}\]/,/^## \[/ {if (/^## \[${VERSION}\]/) p=1; if (p && /^## \[/ && !/^## \[${VERSION}\]/) exit; if (p) print}" CHANGELOG.md)

          # Save to file for upload
          echo "${CHANGELOG_SECTION}" > release_notes.md
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: Release ${{ steps.create_tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binary:
    name: Build macOS Binary
    needs: finalize-release
    runs-on: macos-latest
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Checkout code at tag
        run: |
          git checkout ${{ steps.get_tag.outputs.tag }}

      - name: Ensure new release was created
        id: check_new_release
        run: |
          # Get the commit hash for the tag
          TAG_COMMIT=$(git rev-list -n 1 ${{ steps.get_tag.outputs.tag }})
          # Get the commit hash for HEAD
          HEAD_COMMIT=$(git rev-parse HEAD)
          if [ "$TAG_COMMIT" != "$HEAD_COMMIT" ]; then
            echo "No new release was created in this run. Skipping binary build."
            exit 1
          fi
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller

      - name: Build binary with PyInstaller
        run: |
          pyinstaller --onefile --name run-calc bin/run_calc.py

      - name: Test binary
        run: |
          ./dist/run-calc add 2 3
          ./dist/run-calc multiply 4 5
          ./dist/run-calc average 10 20 30
          ./dist/run-calc --help

      - name: Rename binary
        run: |
          mv dist/run-calc dist/run-calc-macos-arm64

      - name: Upload binary to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          files: dist/run-calc-macos-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
